# Sync rules for Chronolog PowerSync service
# Defines per-user data buckets using request.user_id() (JWT sub claim)
#
# All tables have a denormalized user_id column for PowerSync compatibility.
# PowerSync data queries must SELECT from a single table (no JOINs/subqueries).

bucket_definitions:
  # Single bucket per user containing all their data
  user_data[]:
    parameters: SELECT request.user_id() as user_id
    data:
      - SELECT * FROM clients WHERE clients.user_id = bucket.user_id
      - SELECT * FROM contracts WHERE contracts.user_id = bucket.user_id
      - SELECT * FROM deliverables WHERE deliverables.user_id = bucket.user_id
      - SELECT * FROM work_types WHERE work_types.user_id = bucket.user_id
      - SELECT * FROM time_entries WHERE time_entries.user_id = bucket.user_id
      - SELECT * FROM notes WHERE notes.user_id = bucket.user_id
      - SELECT * FROM note_links WHERE note_links.user_id = bucket.user_id
      - SELECT * FROM note_time_entries WHERE note_time_entries.user_id = bucket.user_id
      - SELECT * FROM weekly_statuses WHERE weekly_statuses.user_id = bucket.user_id
      - SELECT id, note_id, user_id, filename, mime_type, size_bytes, created_at FROM attachments WHERE attachments.user_id = bucket.user_id
